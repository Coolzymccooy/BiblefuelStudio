import{c as f,r,j as s,B as o,b as i}from"./index-CfOaS_bp.js";import{C as T}from"./Card-0Ip1zazd.js";import{B as J}from"./Badge-DZHWqAuq.js";import{l as R,S as A}from"./storage-DAnXyH0z.js";import{C as E}from"./circle-play-B4xVvWUl.js";import{R as _}from"./refresh-cw-Dh0i9_X3.js";import{E as D}from"./external-link-C7F0zhn_.js";import{D as P}from"./download-D87_8The.js";const L=[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],$=f("clock",L);const z=[["path",{d:"M12 19h8",key:"baeox8"}],["path",{d:"m4 17 6-6-6-6",key:"1yngyt"}]],q=f("terminal",z);function U(){const[n,y]=r.useState([]),[N,u]=r.useState(!1),[x,w]=r.useState(null),[b,p]=r.useState(!1),g=r.useRef(0),h=r.useRef([]);r.useEffect(()=>{h.current=n},[n]);const l=async(e=!1)=>{e&&u(!0);try{const t=await i.get("/api/jobs");if(t.ok&&t.data?.jobs){const c=t.data.jobs,m=h.current.some(a=>a.status==="queued"||a.status==="running");if(c.length===0&&m){g.current+=1;return}else g.current=0;y(c)}}catch(t){console.error("Failed to refresh jobs",t)}finally{e&&u(!1)}};r.useEffect(()=>{l(!0);const e=setInterval(()=>{document.visibilityState==="visible"&&l(!1)},5e3);return()=>clearInterval(e)},[]);const v=async()=>{await l(!0)},k=e=>{switch(e){case"done":return"success";case"running":return"warning";case"failed":return"danger";default:return"default"}},j=e=>{const t=e.split(/[\\/]/).pop()||e;i.download(`/outputs/${t}`)},S=e=>{const t=e.split(/[\\/]/).pop()||e;window.open(`${i.baseUrl}/outputs/${t}`,"_blank")},C=async()=>{p(!0);try{const e=await i.get("/api/library"),t=e.ok?e.data?.library?.items?.[0]:null;if(!t?.id){alert("Library is empty. Add a background first.");return}const d=R(A.audioHistory,[])[0]?.path||"",m={type:"render_video",payload:{backgroundPath:t.id,...d?{audioPath:d}:{},lines:["Test render job","Psalm 34:18","God is near.","Auto-generated"],durationSec:20}},a=await i.post("/api/jobs/enqueue",m);a.ok?(alert("Test job enqueued. Check status below."),await l(!0)):alert(a.error||"Failed to enqueue test job")}finally{p(!1)}};return s.jsxs("div",{className:"space-y-6 animate-fade-in",children:[s.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[s.jsxs("div",{children:[s.jsx("h2",{className:"text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400 mb-2 text-white",children:"Background Jobs"}),s.jsx("p",{className:"text-gray-400",children:"Track rendering and background processes."})]}),s.jsxs("div",{className:"flex flex-wrap items-center gap-2 w-full sm:w-auto",children:[s.jsxs(o,{onClick:C,isLoading:b,variant:"secondary",className:"w-full sm:w-auto",children:[s.jsx(E,{size:16,className:"mr-2"}),"Trigger Test Job"]}),s.jsxs(o,{onClick:v,isLoading:N,className:"w-full sm:w-auto",children:[s.jsx(_,{size:16,className:"mr-2"}),"Refresh"]})]})]}),s.jsx(T,{className:"min-h-[500px]",children:n.length===0?s.jsxs("div",{className:"text-center py-20 text-gray-500",children:[s.jsx(q,{size:48,className:"mx-auto mb-4 opacity-20"}),s.jsx("p",{children:"No jobs in the queue."})]}):s.jsx("div",{className:"space-y-3",children:n.map(e=>s.jsxs("div",{className:"bg-dark-900/40 border border-white/5 rounded-xl p-4 hover:border-white/10 hover:bg-dark-900/60 transition-all cursor-pointer group",onClick:()=>w(x?.id===e.id?null:e),children:[s.jsxs("div",{className:"flex items-start justify-between",children:[s.jsxs("div",{className:"flex-1",children:[s.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[s.jsx(J,{variant:k(e.status),className:"uppercase text-[10px] tracking-wider font-bold",children:e.status}),s.jsx("span",{className:"font-semibold text-gray-200",children:e.type}),s.jsxs("span",{className:"text-xs text-gray-500 font-mono",children:["#",e.id.slice(0,8)]})]}),s.jsxs("div",{className:"flex items-center gap-4 text-xs text-gray-400",children:[s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx($,{size:12}),new Date(e.createdAt).toLocaleString()]}),e.finishedAt&&s.jsxs("div",{className:"text-emerald-400/80 font-medium",children:["Duration: ",Math.round((new Date(e.finishedAt).getTime()-(e.startedAt?new Date(e.startedAt).getTime():new Date(e.createdAt).getTime()))/1e3),"s"]})]}),e.status==="failed"&&e.error&&s.jsx("div",{className:"mt-2 text-xs text-red-300/90 truncate",title:e.error,children:e.error})]}),s.jsxs("div",{className:"flex flex-col items-end gap-2",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[e.status==="running"&&s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-24 h-1.5 bg-white/5 rounded-full overflow-hidden border border-white/5",children:s.jsx("div",{className:"h-full bg-primary-500 shadow-[0_0_10px_rgba(var(--primary-500-rgb),0.5)] transition-all duration-500",style:{width:`${e.progress||0}%`}})}),s.jsxs("span",{className:"text-[10px] font-bold text-primary-400 font-mono",children:[e.progress||0,"%"]})]}),e.status==="done"&&e.result?.outFile&&s.jsxs("div",{className:"flex gap-2",children:[s.jsxs(o,{onClick:t=>{t.stopPropagation(),S(e.result.outFile)},className:"text-xs px-3 py-1 bg-white/10 hover:bg-white/20 text-white border-white/10 h-auto",children:[s.jsx(D,{size:14,className:"mr-1.5"}),"Play"]}),s.jsxs(o,{onClick:t=>{t.stopPropagation(),j(e.result.outFile)},className:"text-xs px-3 py-1 bg-primary-500/10 hover:bg-primary-500/20 text-primary-400 border-primary-500/20 h-auto",children:[s.jsx(P,{size:14,className:"mr-1.5"}),"Download"]})]})]}),e.status==="running"&&s.jsx("span",{className:"text-[10px] text-primary-400/50 uppercase tracking-widest font-bold animate-pulse",children:"Processing..."})]})]}),x?.id===e.id&&s.jsx("div",{className:"mt-4 pt-4 border-t border-white/5 animate-in slide-in-from-top-2 duration-200",children:s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-xs",children:[e.payload&&s.jsxs("div",{className:"space-y-2",children:[s.jsx("span",{className:"font-semibold text-gray-400",children:"Payload:"}),s.jsx("pre",{className:"bg-black/30 p-3 rounded-lg overflow-auto border border-white/5 font-mono text-gray-300 max-h-40 custom-scrollbar",children:JSON.stringify(e.payload,null,2)})]}),(e.result||e.error)&&s.jsxs("div",{className:"space-y-2",children:[s.jsx("span",{className:`font-semibold ${e.error?"text-red-400":"text-emerald-400"}`,children:e.error?"Error Log:":"Result Output:"}),s.jsx("pre",{className:`p-3 rounded-lg overflow-auto border font-mono max-h-40 custom-scrollbar ${e.error?"bg-red-500/5 border-red-500/20 text-red-300":"bg-emerald-500/5 border-emerald-500/20 text-emerald-300"}`,children:e.error||JSON.stringify(e.result,null,2)})]})]})})]},e.id))})})]})}export{U as JobsPage};
